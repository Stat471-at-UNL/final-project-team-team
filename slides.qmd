---
title: "Comparing Imputation Quality of Different Coordinate Systems for Statistical Modeling"
author:
  - "Tyler Davis"
  - "Grey Gergen"
  - "Jack Macfadyen"
  - "Jesus Rodriguez"
format:
  revealjs:
    theme: simple
    slide-number: true
    transition: fade
    code-fold: true
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(tidyverse)
library(patchwork)
library(naniar)
library(skimr)
library(visdat)
library(mice)
library(rapportools) 
library(knitr)
library(kableExtra)
library(sf)
library(psych)
library(car)
source("data_pull.R")
```

```{r data-cleaning}
data_documentation <- 
  readr::read_csv(
    "Inside Airbnb Data Dictionary - listings.csv detail v4.3.csv",
    skip = 7,
    col_names = T) %>% 
  slice(1:(79-4))

filter_df <- df 

filter_df[filter_df == "N/A"] <- NA
filter_df[filter_df == ""] <- NA
filter_df[filter_df == "[]"] <- NA
filter_df[filter_df == "-"] <- NA

filter_df <-
  filter_df %>% 
  mutate(
    price = str_remove_all(price, "\\$"),
    price = str_remove_all(price, "\\,"),
    price = as.numeric(price), 
    id = as.factor(id)
  ) %>% 
  filter(price <= 10000 | is.na(price)) %>% 
  mutate(
    bathrooms =
      case_when(
        str_detect(bathrooms_text, "H|half") ~ 0.5,
        is.na(bathrooms) ~ str_extract(bathrooms_text, "\\d+\\.?\\d*") %>% as.numeric(),
        TRUE ~ bathrooms
      )
  )

filter_df$host_response_rate <- as.numeric(sub("%", "", filter_df$host_response_rate)) / 100
filter_df$host_acceptance_rate <- as.numeric(sub("%", "", filter_df$host_acceptance_rate)) / 100
filter_df$bathrooms <- ifelse(is.na(filter_df$bathrooms), as.numeric(sub(" .*", "", filter_df$bathrooms_text)), filter_df$bathrooms)

filter_df <- 
  filter_df %>% 
  mutate(
    across(
      c(
        neighbourhood_group_cleansed,
        neighbourhood_cleansed,
        property_type, 
        room_type,
        host_id,
        host_is_superhost,
        host_response_time
      ), 
      as.factor
    )
  )
```

## Motivation

- The **Geographic Coordinate System (GCS)** is a non-Cartesian, global standard that communicates position using latitude and longitude.

- The **Universal Transverse Mercator (UTM)** is a projection-based mapping of Earth that creates 60 zones with coordinates more easily interpreted on a linear scale.

- Do different coordinate systems lead to different imputations, and does that affect modeling?

- We will use New York Airbnb data as a case study.

## Data Description

- Airbnb data for major cities has been scraped by contributors and gathered on [insideairbnb.com](https://insideairbnb.com/get-the-data/) in October 2025.

- We took a sample of all Airbnb listings from New York City.

- Of the `r nrow(df)` listings in the data, `r sum(rapportools::is.empty(df$price))` (41%) had missing price values.

- This gives us an opportunity to use various variables, including location with our two coordinate systems, to reliably impute the missing pricing data.

## Variable Overview

Of the various variables in the dataset, we considered strong, interpretable predictors of price:

- Number of **bedrooms**
- Number of **beds**
- Number of **bathrooms**
- Total amount of people who could be **accommodated**
- **Location** (latitude and longitude)

## Bedrooms

The amount of bedrooms available in the listing.

```{r}
histogram <- 
  filter_df %>% 
  ggplot(aes(bedrooms)) + 
  geom_histogram(binwidth = 1, color = 'black', fill = "grey")

histogram
```

## Beds

The total amount of beds in the listing.

```{r}
histogram <- 
  filter_df %>% 
  ggplot(aes(beds)) + 
  geom_histogram(binwidth = 1, color = 'black', fill = "grey")

histogram
```

## Bathrooms

The amount of available bathrooms in the listing.

```{r}
histogram <- 
  filter_df %>% 
  ggplot(aes(bathrooms)) + 
  geom_histogram(binwidth = 1, color = 'black', fill = "grey")

histogram
```

## Accommodates

The total amount of people that can be accommodated in the listing.

```{r}
histogram <- 
  filter_df %>% 
  ggplot(aes(accommodates)) + 
  geom_histogram(binwidth = 1, color = 'black', fill = "grey")

histogram
```

## Model Construction

- The price variable will be imputed first using geographic coordinates and then once more with UTM as a separate dataset.

- The model will then be run with each dataset and model accuracy will be analyzed.

- The final model was developed from a variety of model building techniques, along with understanding our predictors of interest.

## Statistical Model

$$\text{log(price)} = \beta_0 + \beta_1(\text{bedrooms}) + \beta_2(\text{beds}) +$$
$$\beta_3(\text{latitude}) + \beta_4(\text{longitude}) +$$

$$\beta_5(\text{latitude} \times \text{longitude}) + \beta_6(\text{accommodates})+ \beta_7(\text{bathrooms})$$

```{r model}
model1 <-
  filter_df %>%
  lm(log(price) ~ bedrooms + beds + latitude*longitude + accommodates + bathrooms, data = .)
```

## Imputation Analysis

- Of the `r sum(rapportools::is.empty(df$price))` missing price values, there are only 355 occurrences when price is the only missing variable.

- Most commonly, when price is missing, beds is also missing.

- There were no observations where latitude, longitude, or accommodates were missing.

- Price is imputed using **predictive mean matching** from the `mice` package in R.

## Missing values

![](missing_plot.png)

## Imputation Process

```{r imputation-gcs}
#| include: false
airbnb_imputation <-
  filter_df %>%
  mutate(latitude = scale(latitude)[,1], longitude = scale(longitude)[,1]) %>%
  select(latitude, longitude, accommodates, bathrooms, bedrooms, beds, price) %>%
  mice(data = ., m = 5, method = "pmm", seed = 20251125)

completed_list <- complete(airbnb_imputation, "all") %>% map(as_tibble)

fit1 <- with(airbnb_imputation, lm(log(price) ~
             bedrooms + bathrooms + beds +
             accommodates +
             latitude*longitude))

pooled <- pool(fit1)
```

```{r imputation-utm}
#| include: false
model_dat <- filter_df %>%
  select(price, latitude, longitude, bedrooms, beds, bathrooms, accommodates)
points <- st_as_sf(model_dat, coords = c("longitude", "latitude"), crs = 4326)
points_utm <- st_transform(points, crs = 32618)
coords <- st_coordinates(points_utm)
updates <- data.frame(
  price = model_dat$price,
  X = scale(coords[,1]),
  Y = scale(coords[,2]),
  bathrooms = model_dat$bathrooms,
  bedrooms = model_dat$bedrooms,
  beds = model_dat$beds,
  accommodates = model_dat$accommodates
)

impA <- mice(updates, m = 5, method = "pmm", seed = 123)
fit <- with(impA, lm(log(price) ~
             bedrooms + bathrooms + beds +
             accommodates +
             X*Y))
pooled1 <- pool(fit)
```

- Model accuracy of both imputations will be compared using **AIC** and **BIC**.

- **Root Mean Square Error (RMSE)** of each imputation method will also be calculated and statistically tested.

## Comparing Model Accuracy Between Predictor Sets

```{r model-comparison}
get_avg_fit <- function(model) {
  models <- model$analyses
  aic_vals <- sapply(models, AIC)
  bic_vals <- sapply(models, BIC)
  data.frame(
    `Mean AIC` = mean(aic_vals),
    `Mean BIC` = mean(bic_vals),
    check.names = F
  )
}

total_fit <- rbind(
  GCS = get_avg_fit(fit1),
  UTM = get_avg_fit(fit)
)

kable(total_fit, digits = 3)
```

For both metrics, the model with **GCS-imputed data** has a lower value, suggesting that the model is a better fit and represents the relationship to price better than the dataset imputed with UTM.

## Comparing Imputation Methods with RMSE

- AIC and BIC do not have anything to say about imputation *quality*.

- This difference can be tested by comparing RMSE for each imputation method.

- We mask 10% of the price values that are not missing, then impute using each predictor set and calculate the RMSE.

- This process is simulated 10 times and the mean RMSE values are compared.

```{r rmse-setup}
#| warning: false
#| include: false
updates$lat <- model_dat$latitude
updates$long <- model_dat$longitude
data_mask <- updates
data_mask$y2 <- data_mask$Y^2
data_mask$x2 <- data_mask$X^2
data_mask$xy <- data_mask$X*data_mask$Y
data_mask$latlong <- data_mask$lat*data_mask$long
mask <- sample(which(!is.na(data_mask$price)), size = floor(0.1 * nrow(data_mask)))
data_mask$price_mask <- data_mask$price
data_mask$price_mask[mask] <- NA

# Only impute price
meth <- make.method(data_mask)
meth[] <- ""
meth["price_mask"] <- "pmm"
predA <- make.predictorMatrix(data_mask)
predA[, ] <- 0
predA["price_mask", c("X","Y","xy","beds","bathrooms","bedrooms","accommodates")] <- 1
predB <- make.predictorMatrix(data_mask)
predB[, ] <- 0
predB["price_mask", c("lat","long","latlong","beds","bathrooms","bedrooms","accommodates")] <- 1
predC <- make.predictorMatrix(data_mask)
predC[, ] <- 0
predC["price_mask", c("X","Y","lat","long","xy","latlong","beds","bathrooms","bedrooms","accommodates")] <- 1

rmse_mask <- function(imp_obj, mask) {
  # long format to average imputations
  completed <- complete(imp_obj, "long")  # .imp and .id columns
  # average over imputations
  avg_imp <- aggregate(price_mask ~ .id, data = completed, FUN = mean)
   avg_imp <- avg_imp[order(avg_imp$.id), ]
  # RMSE on masked indices
  true_vals <- data_mask$price[mask]
  pred_vals <- avg_imp$price_mask[mask]
  sqrt(mean((pred_vals - true_vals)^2))
}

predictor_sets <- list(
  UTM = predA,
  GCS = predB
)
simulate_rmse <- function(data, predictor_sets, n_sim = 10, mask_frac = 0.1, m = 5, seed = 5686432) {
  set.seed(seed)
  results <- list()
  for (pred_name in names(predictor_sets)) {
    rmse_vec <- numeric(n_sim)
    for (i in 1:n_sim) {
      # Mask a fraction of prices
      mask_idx <- sample(which(!is.na(data$price)), size = floor(mask_frac * nrow(data)))
      data$price_mask <- data$price
      data$price_mask[mask_idx] <- NA
      # Method vector
      meth <- rep("", ncol(data))
      names(meth) <- colnames(data)
      meth["price_mask"] <- "pmm"
      # Predictor matrix
      pred <- predictor_sets[[pred_name]]
      pred <- pred[colnames(data), colnames(data)]
      # Run mice
      imp <- mice(data, m = m, method = meth, predictorMatrix = pred, seed = seed + i, printFlag = FALSE)
      # Compute RMSE using external function
      rmse_vec[i] <- rmse_mask(imp, mask_idx)
    }
    results[[pred_name]] <- rmse_vec
  }
  return(results)
}
sim_results <- simulate_rmse(data_mask, predictor_sets, n_sim = 10, mask_frac = 0.1)

summary_rmse <- data.frame(
  `Predictor Set` = names(sim_results),
  `Mean RMSE` = sapply(sim_results, mean),
  SD_RMSE = sapply(sim_results, sd),
  Min_RMSE = sapply(sim_results, min),
  Max_RMSE = sapply(sim_results, max),
  check.names = F
)
summary_rmse$SE <- summary_rmse$SD_RMSE/sqrt(10)
summary_rmse$`CI (95%)` <- paste0("(",round(summary_rmse$`Mean RMSE` - 1.96*(summary_rmse$SE),2)," - ",round(summary_rmse$`Mean RMSE` + 1.96*(summary_rmse$SE),2),")")
```

## RMSE Results

```{r rmse-table}
summary_rmse <- summary_rmse %>%
  arrange(desc(row_number()))
kable(summary_rmse[,-c(1,3,4,5)], digits = 3)
```

- UTM predictor set has the slightly lower RMSE, signifying it could have higher imputation accuracy.

- GCS predictor set has the lower SE which indicates slightly less variability.

- These results do not give significant conclusions and need to be statistically tested.

## ANOVA: RMSE vs. Predictor Sets

```{r anova-test}
rmse_list <- data.frame(
  rmse = unlist(sim_results),
  predictors = rep(names(sim_results), times = sapply(sim_results, length))
)
rmse_model <- aov(rmse ~ predictors, rmse_list)
kable(anova(rmse_model), digits = 3)
```

We **fail to reject the null hypothesis** (p-value = 0.94), which is that the predictor sets' mean RMSE values are equal.

## Conclusion

- Geographic coordinates and UTM **do not differ** in imputation quality in the case of Airbnb data for New York City.

- The RMSE values were shown to be **not significantly different**.

- We cannot claim that switching to UTM as a distance-based coordinate system leads to better imputation for modeling than GCS.

- This outcome could have been influenced by the **size of the analysis area** (New York City) and have different results if a differently-sized area was considered.

## Future Directions

- The procedure from this study can potentially be used for analyzing the imputation quality of **other coordinate systems**.

- Further analysis of this data to build a **more complex model** and test its predictive quality.
